<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ±</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        #preview { width: 300px; margin: 20px auto; display: none; border: 2px solid #ccc; }
        #qr-status, #location-status { margin-top: 10px; font-weight: bold; }
        button { margin: 10px; padding: 10px 20px; font-size: 16px; }
    </style>
</head>
<body>

    <h2>ğŸ“Œ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ±</h2>

    <button id="qr-btn">1ï¸âƒ£ Ø§Ø³ÙƒØ§Ù† QR Code</button>
    <div id="preview"></div>
    <div id="qr-status"></div>



    <button id="location-btn" style="display:none;">2ï¸âƒ£ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</button>
    <div id="location-status"></div>

    <script>
        const qrBtn = document.getElementById("qr-btn");
        const previewElement = document.getElementById("preview");
        const qrStatus = document.getElementById("qr-status");
        const locationBtn = document.getElementById("location-btn");
        const locationStatus = document.getElementById("location-status");

        let scannedCode = null;

        qrBtn.addEventListener("click", () => {
            previewElement.style.display = "block";
            const html5QrCode = new Html5Qrcode("preview");

            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText, decodedResult) => {
                    html5QrCode.stop().then(() => {
                        previewElement.innerHTML = "";
                        previewElement.style.display = "none";
                        scannedCode = decodedText;

                        fetch(`/attendance/verify_qr/?qr_code_data=${encodeURIComponent(scannedCode)}`)
                            .then(res => res.json())
                            .then(data => {
                                qrStatus.innerHTML = (data.status === 'success')
                                    ? "âœ… Ø§Ù„ÙƒÙˆØ¯ ØµØ­ÙŠØ­: " + data.message
                                    : "âŒ Ø®Ø·Ø£: " + data.message;

                                if (data.status === 'success') {
                                    locationBtn.style.display = "inline";
                                }
                            });
                    });
                },
                (errorMessage) => {
                    console.warn("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙƒÙˆØ¯:", errorMessage);
                }
            ).catch(err => {
                console.error("ÙØ´Ù„ ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:", err);
            });
        });

        locationBtn.addEventListener("click", () => {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        fetch("/attendance/verify_location/", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": getCookie("csrftoken")
                            },
                            body: JSON.stringify({ latitude: lat, longitude: lon })
                        })
                        .then(res => res.json())
                        .then(data => {
                            locationStatus.innerHTML = (data.status === 'success')
                                ? "âœ… Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØµØ­ÙŠØ­: " + data.message
                                : "âŒ " + data.message;
                        });
                    },
                    (error) => {
                        locationStatus.innerHTML = "âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹: " + error.message;
                    }
                );
            } else {
                locationStatus.innerHTML = "âŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ";
            }
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

</body>
</html>

<!-- http://127.0.0.1:8000/attendance/student_page/ -->